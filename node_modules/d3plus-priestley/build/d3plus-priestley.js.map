{"version":3,"file":"d3plus-priestley.js","sources":["../src/Priestley.js"],"sourcesContent":["/**\n    @external Viz\n    @see https://github.com/d3plus/d3plus-viz#Viz\n*/\n\nimport {min, max, range} from \"d3-array\";\nimport {nest} from \"d3-collection\";\nimport {scalePoint} from \"d3-scale\";\n\nimport {Axis, date} from \"d3plus-axis\";\nimport {accessor, assign, configPrep, elem} from \"d3plus-common\";\nimport {Rect} from \"d3plus-shape\";\nimport {Viz} from \"d3plus-viz\";\n\n/**\n    @class Priestley\n    @extends external:Viz\n    @desc Creates a priestley timeline based on an array of data.\n*/\nexport default class Priestley extends Viz {\n\n  /**\n      @memberof Priestley\n      @desc Invoked when creating a new class instance, and sets any default parameters.\n      @private\n  */\n  constructor() {\n\n    super();\n    this._axis = new Axis().align(\"end\").orient(\"bottom\");\n    this._axisConfig = {scale: \"time\"};\n    this._axisTest = new Axis().align(\"end\").gridSize(0).orient(\"bottom\");\n    this.end(\"end\");\n    this.start(\"start\");\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc Extends the render behavior of the abstract Viz class.\n      @private\n  */\n  render(callback) {\n\n    super.render(callback);\n\n    if (!this._filteredData) return this;\n\n    const data = this._filteredData.map((data, i) => ({\n      __d3plus__: true,\n      data,\n      end: this._axisConfig.scale === \"time\" ? date(this._end(data, i)) : this._end(data, i),\n      i,\n      id: this._id(data, i),\n      start: this._axisConfig.scale === \"time\" ? date(this._start(data, i)) : this._start(data, i)\n    })).filter(d => d.end - d.start > 0).sort((a, b) => a.start - b.start);\n\n    let nestedData;\n    if (this._groupBy.length > 1 && this._drawDepth > 0) {\n      const dataNest = nest();\n      for (let i = 0; i < this._drawDepth; i++) dataNest.key(d => this._groupBy[i](d.data, d.i));\n      nestedData = dataNest.entries(data);\n    }\n    else nestedData = [{values: data}];\n\n    let maxLane = 0;\n    nestedData.forEach(g => {\n      let track = [];\n      g.values.forEach(d => {\n        track = track.map(t => t <= d.start ? false : t);\n        const i = track.indexOf(false);\n        if (i < 0) {\n          d.lane = maxLane + track.length;\n          track.push(d.end);\n        }\n        else {\n          track[i] = d.end;\n          d.lane = maxLane + i;\n        }\n      });\n      maxLane += track.length;\n    });\n\n    const axisConfig = {\n      domain: [min(data, d => d.start) || 0, max(data, d => d.end) || 0],\n      height: this._height - this._margin.top - this._margin.bottom,\n      width: this._width - this._margin.left - this._margin.right\n    };\n\n    const transform = `translate(${this._margin.left}, ${this._margin.top})`;\n\n    this._axisTest\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis-test\", {parent: this._select, enter: {opacity: 0}}).node())\n      .render();\n\n    this._axis\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis\", {parent: this._select, enter: {transform}, update: {transform}}).node())\n      .render();\n\n    const axisPad = this._axisTest._padding;\n\n    const xScale = this._axis._d3Scale;\n\n    const yScale = scalePoint()\n      .domain(range(0, maxLane, 1))\n      .padding(0.5)\n      .rangeRound([this._height - this._margin.bottom - this._axisTest.outerBounds().height - axisPad, this._margin.top + axisPad]);\n\n    const step = yScale.step();\n\n    this._shapes.push(new Rect()\n      .data(data)\n      .duration(this._duration)\n      .height(step >= this._padding * 2 ? step - this._padding : step > 2 ? step - 2 : step)\n      .label((d, i) => this._drawLabel(d.data, i))\n      .select(elem(\"g.d3plus-priestley-shapes\", {parent: this._select}).node())\n      .width(d => {\n        const w = Math.abs(xScale(d.end) - xScale(d.start));\n        return w > 2 ? w - 2 : w;\n      })\n      .x(d => xScale(d.start) + (xScale(d.end) - xScale(d.start)) / 2)\n      .y(d => yScale(d.lane))\n      .config(configPrep.bind(this)(this._shapeConfig, \"shape\", \"Rect\"))\n      .render());\n\n    return this;\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the config method for the axis and returns the current class instance. If *value* is not specified, returns the current axis configuration.\n      @param {Object} [*value*]\n      @chainable\n  */\n  axisConfig(_) {\n    return arguments.length ? (this._axisConfig = assign(this._axisConfig, _), this) : this._axisConfig;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the end accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current end accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  end(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._end = _;\n      else {\n        this._end = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => max(a);\n      }\n      return this;\n    }\n    else return this._end;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the start accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current start accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  start(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._start = _;\n      else {\n        this._start = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => min(a);\n      }\n      return this;\n    }\n    else return this._start;\n  }\n\n}\n"],"names":["super","Axis","const","this","date","let","nest","i","min","max","elem","scalePoint","range","Rect","configPrep","assign","accessor","Viz"],"mappings":"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"}